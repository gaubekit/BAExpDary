{{ block title }} Choice Reaction Time with One Color {{ endblock }} {{ block
content }}

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Choice Reaction Task</title>
  <style>
    body {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background-color: #f0f0f0;
    }

    .circle-container {
      position: relative;
      width: 400px;
      height: 400px;
    }

    .circle-button {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 24px;
      font-weight: bold;
      color: #000;
      border: 1px solid #333;
      background-color: gray;
      cursor: pointer;
      position: absolute;
      user-select: none;
    }

    #center-circle {
      top: 300px;
      left: 170px;
      width: 60px;
      height: 60px;
      background-color: white;
      border: none;
      cursor: default;
      pointer-events: none;
      display: flex;
      justify-content: center;
      align-items: center;
      font-weight: bold;
      font-size: 12px;
      color: black;
      text-align: center;
    }

    .circle-button.active {
      background-color: #005000;
    }
  </style>
</head>

<body>
  <div class="circle-container">
    <div class="circle-button" id="circle1">1</div>
    <div class="circle-button" id="circle2">2</div>
    <div class="circle-button" id="circle3">3</div>
    <div class="circle-button" id="circle4">4</div>
    <div class="circle-button" id="circle5">5</div>
    <div class="circle-button" id="center-circle"></div>
  </div>

  <div id="next-container" style="display: none">
      <p>{{ next_button }}</p>
  </div>

  <script>
    // --- DOM References ---
    const circleElements = [
      document.getElementById("circle1"),
      document.getElementById("circle2"),
      document.getElementById("circle3"),
      document.getElementById("circle4"),
      document.getElementById("circle5"),
    ];
    const centerCircle = document.getElementById("center-circle");

    // --- Circle Layout Configuration ---
    const centerX = 200;
    const centerY = 330;
    const radius = 160;
    const angleOffset = Math.PI / 2;
    const spread = Math.PI / 1.3;
    const startAngle = angleOffset - spread / 2;

    // Position circles in a fan-like arc
    const circles = [...circleElements].reverse();
    circles.forEach((circle, i) => {
      const angle = startAngle + (i * spread) / (circles.length - 1);
      const x = centerX + radius * Math.cos(angle) - 30;
      const y = centerY - radius * Math.sin(angle) - 30;
      circle.style.left = `${x}px`;
      circle.style.top = `${y}px`;
    });

    // --- Trial State Variables ---
    let activeIndex = -1;
    let trialIndex = 0;
    let stimulusTime = null;
    let timeoutId = null;

    /**
     * Displays a short feedback message in the center circle.
     * @param {string} text - Message to display
     */
    function showMessage(text) {
      centerCircle.innerText = text;
      setTimeout(() => {
        centerCircle.innerText = "";
      }, 1000); // 1s duration
    }

    /**
     * Returns a random index from 0 to the number of circles - 1.
     * @returns {number}
     */
    function getRandomIndex() {
      return Math.floor(Math.random() * circleElements.length);
    }

    /**
     * Highlights a random circle after a random delay (1â€“4s).
     * Also records the time the stimulus appeared.
     */
    function highlightRandomCircle() {
      if (activeIndex !== -1) {
        circleElements[activeIndex].classList.remove("active");
      }

      activeIndex = getRandomIndex();
      const delay = Math.random() * 3000 + 1000;

      timeoutId = setTimeout(() => {
        circleElements[activeIndex].classList.add("active");
        stimulusTime = performance.now();
      }, delay);
    }

    /**
     * Records the user's response data and sends it via liveSend.
     * @param {number} index - The index of the clicked or pressed circle
     */
    function recordReaction(index) {
      const responseTime = performance.now() - stimulusTime;

      liveSend({
        trial_index: trialIndex,
        clicked_index: index,
        is_correct: index === activeIndex,
        reaction_time: responseTime.toFixed(2),
      });

      trialIndex++;
    }

    /*
    // --- Event Listeners (Mouse-Based) ---
    // Uncomment this section if you want to allow mouse clicks
    
    circleElements.forEach((circle, index) => {
      circle.addEventListener('click', () => {
        if (index === activeIndex) {
          showMessage('Correct!');
        } else {
          showMessage('Wrong!');
        }
        recordReaction(index);
        highlightRandomCircle();
      });
    });
    */

    // --- Event Listeners (Keyboard-Based) ---

    document.addEventListener("keydown", (e) => {
      const key = parseInt(e.key);
      if (!isNaN(key) && key >= 1 && key <= 5) {
        const index = key - 1;

        if (index === activeIndex) {
          clearTimeout(timeoutId);
          showMessage("Correct!");
        } else {
          showMessage("Wrong!");
        }

        recordReaction(index);
        highlightRandomCircle();
      }
    });

    // --- Start First Trial ---
    highlightRandomCircle();

    window.addEventListener("load", () => {
      // Time in milliseconds (2 minutes)
      const autoAdvanceMs = 2 * 60 * 1000;

      setTimeout(() => {
        document.getElementById("next-container").style.display = "block";
      }, autoAdvanceMs);
    });
  </script>
</body>

{{ formfields }} {{ endblock }}
