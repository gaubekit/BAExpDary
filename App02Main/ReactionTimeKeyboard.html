{{ block title }} Reaction Time {{ endblock }} {{ block content }} {% load otree
static %}
<link rel="stylesheet" href="{% static 'styles/assessment.css' %}" />

<div class="task-container">
  <p class="task-description">
    Press the "3" key as soon as the circle turns green. Do not press it too
    early.
  </p>

  <div class="circle-container">
    <div class="circle-button" id="center-circle"></div>
    <div id="message"></div>
  </div>
</div>

<div id="next-container" style="display: none">
  <p>{{ next_button }}</p>
</div>

<script>
  // --- DOM References ---
  const centerCircle = document.getElementById("center-circle");
  const message = document.getElementById("message");

  // --- State Variables ---
  let taskActive = true; // <-- stop-flag: when false, no more trials or sends
  let isGreen = false;
  let waiting = false;
  let timeoutId = null; // random delay to show green
  let messageTimeoutId = null; // clears feedback message
  let nextTrialTimeoutId = null; // schedules the next trial
  let stimulusShownAt = null;
  let trialIndex = 0;

  /**
   * Displays a short feedback message below the circle.
   * @param {string} text - Message to display
   */
  function showMessage(text) {
    if (!taskActive) return;
    message.innerText = text;
    centerCircle.innerText = "";
    // Message visible for 1s
    clearTimeout(messageTimeoutId);
    messageTimeoutId = setTimeout(() => {
      if (!taskActive) return;
      message.innerText = "";
    }, 1000); // Message visible for 1s
  }

  /**
   * Starts a new trial: waits, then turns the circle green.
   */
  function startTrial() {
    if (!taskActive) return;
    isGreen = false;
    waiting = true;
    stimulusShownAt = null;
    centerCircle.style.backgroundColor = "gray";

    // Clear any pending timers from prior trial
    clearTimeout(timeoutId);
    clearTimeout(nextTrialTimeoutId);

    // Random delay between 1â€“4s
    const delay = Math.random() * 3000 + 1000;
    timeoutId = setTimeout(() => {
      if (!taskActive) return;
      centerCircle.style.backgroundColor = "#005000"; // Green = go
      centerCircle.innerText = "3";
      isGreen = true;
      waiting = false;
      stimulusShownAt = performance.now();
    }, delay);
  }

  /**
   * Handles participant's response via key.
   * Sends RT if correct or gives early warning.
   */
  function handleClick() {
    if (!taskActive) return;

    if (waiting && !isGreen) {
      // Premature response
      clearTimeout(timeoutId);
      showMessage("Too soon!");
      startTrial(); // Restart trial on premature click
    } else if (isGreen) {
      const rt = performance.now() - stimulusShownAt;

      showMessage("Correct!");
      // Guard to avoid sends after timer
      if (taskActive) {
        liveSend({
          trial_index: trialIndex,
          reaction_time: rt.toFixed(2),
        });
        trialIndex++;
      }

      isGreen = false;
      centerCircle.style.backgroundColor = "gray";

      // Begin next trial after a short delay
      clearTimeout(nextTrialTimeoutId);
      nextTrialTimeoutId = setTimeout(() => {
        if (!taskActive) return;
        startTrial();
      }, 1000);
    }
  }

  // --- Event Listeners ---

  // Respond to keyboard input ("3" key)
  const onKeyDown = (e) => {
    if (e.key === "3") {
      handleClick();
    }
  };
  document.addEventListener("keydown", onKeyDown);

  // Cleanly stop everything and reveal NEXT
  function endTask() {
    if (!taskActive) return;
    taskActive = false;

    // Clear all timers
    [timeoutId, messageTimeoutId, nextTrialTimeoutId].forEach((id) => {
      if (id) clearTimeout(id);
    });

    // UI tidy-up
    waiting = false;
    isGreen = false;
    centerCircle.style.backgroundColor = "gray";
    centerCircle.innerText = "";
    message.innerText = "Time!";

    // Stop further input
    document.removeEventListener("keydown", onKeyDown);

    // Show NEXT
    document.getElementById("next-container").style.display = "block";

    // (Optional) auto-submit page:
    // document.querySelector("form")?.submit();
  }

  // --- Begin Experiment ---
  startTrial();

  window.addEventListener("load", () => {
    // Time in milliseconds (2 minutes)
    const autoAdvanceMs = 2 * 60 * 1000;
    setTimeout(() => endTask(), autoAdvanceMs);
  });
</script>

{{ formfields }} {{ endblock }}
